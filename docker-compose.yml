version: '3.8'

services:
  eth:
    container_name: l2_messaging_eth
    build:
      context: .
      dockerfile: ./ethereum/Dockerfile.local
    env_file:
      - ./scripts/env
    healthcheck:
      test: ["CMD", "netstat", "-tuplen", "|", "grep", "8545"]
      interval: 1s
      timeout: 1s
      retries: 10
    volumes:
      - ./scripts/env:/tmp/env
    ports:
      - 8545:8545

  stark:
    container_name: l2_messaging_stark
    build:
      context: .
      dockerfile: ./starknet/Dockerfile.local
    volumes:
      - ./scripts/env:/tmp/env
    ports:
      - 5050:5050
    depends_on:
      eth:
        condition: service_healthy

# zksync_geth:
#   container_name: l2_messaging_zksync_geth
#   image: "matterlabs/geth:latest"
#   logging:
#       driver: none 
#   ports:
#     - "8545:8545"
#     - "8546:8546"

  zksync_db:
    container_name: l2_messaging_zksync_db
    image: "postgres:12"
    logging:
      driver: none 
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust

  zksync:
    container_name: l2_messaging_zksync
    stdin_open: true
    tty: true
    image: matterlabs/local-node:latest2.0
    depends_on:
      - eth
      - zksync_db
    ports:
      - "3050:3050" # JSON RPC HTTP port
      - "3051:3051" # JSON RPC WS port
    environment:
      - DATABASE_URL=postgres://postgres@zksync_db/zksync_local
      - ETH_CLIENT_WEB3_URL=http://eth:8545
